var he=Object.defineProperty;var me=(e,t,r)=>t in e?he(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var v=(e,t,r)=>me(e,typeof t!="symbol"?t+"":t,r);import{u as M,r as d,G as T,k as Te,h as p,an as re,ao as ve,ap as Ee,S as pe,aq as Re,g as $,ar as Y,$ as L,j as h,F as Ae,a as D,as as xe,L as ae,ac as _e,m as q,at as we,au as ge,N as ne,av as be,f as Se,aw as Fe}from"./index-B-vcvQz_.js";import{l as Pe,s as Ue,f as ye,g as Ce,r as De}from"./voiceListener-BFBkno3b.js";const Be=`precision mediump float;\r
\r
varying highp vec2 texture_coords;\r
\r
uniform sampler2D external_texture;\r
uniform sampler2D u_prev_frame_texture[4];\r
\r
void main()\r
{\r
    vec4 color = texture2D(external_texture, texture_coords);\r
    if (color.rgb != vec3(0.0, 0.0, 0.0)) {\r
        gl_FragColor = color;\r
        return;\r
    }\r
\r
    for (int i = 0; i < 4; i++) {\r
        vec4 prev_color = texture2D(u_prev_frame_texture[i], texture_coords);\r
        if (prev_color.rgb != vec3(0.0, 0.0, 0.0)) {\r
            gl_FragColor = prev_color;\r
            break;\r
        }\r
    }\r
\r
    // if (!foundColor) {\r
    //     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\r
    // }\r
}`,Ie=`attribute vec2 a_position;\r
attribute vec2 a_texcoord;\r
\r
varying vec2 texture_coords;\r
\r
void main() {\r
	gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
	texture_coords = a_texcoord;\r
}`;function ie(e,t,r){const a=e.createShader(t);if(!a)throw new Error("Could not create shader");return e.shaderSource(a,r),e.compileShader(a),a}function Me(e,t){let r;r=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([255,0,0,255])),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.MIRRORED_REPEAT),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);let a=[];for(let i=0;i<t;i++){let s=e.createTexture();s&&(e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.canvas.width,e.canvas.height,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array(e.canvas.width*e.canvas.height*4)),a.push(s))}return{mainTexture:r,prevTextures:a}}function Ne(e,t){let r,a;r=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),e.STATIC_DRAW),a=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),e.STATIC_DRAW);let i=[];for(const s of t){let l=e.createFramebuffer();l&&(e.bindFramebuffer(e.FRAMEBUFFER,l),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0),i.push(l))}return e.bindFramebuffer(e.FRAMEBUFFER,null),{vertexBuffer:r,texcoordBuffer:a,prevBuffers:i}}function Xe(e){const t=ie(e,e.VERTEX_SHADER,Ie),r=ie(e,e.FRAGMENT_SHADER,Be),a=e.createProgram();if(!a)throw new Error("Could not create program");e.attachShader(a,t),e.attachShader(a,r),e.linkProgram(a),e.useProgram(a);const i=e.getAttribLocation(a,"a_position"),s=e.getAttribLocation(a,"a_texcoord");return{program:a,vloc:i,tloc:s}}class Oe{constructor(t){v(this,"quality",1);v(this,"xOffset",0);v(this,"yOffset",0);v(this,"gl",null);v(this,"program",null);v(this,"viewport",{x:0,y:0,width:0,height:0});v(this,"canvasSize",{width:0,height:0});v(this,"animationFrame",null);v(this,"mainTexture",null);v(this,"hasPrevFrame",!1);v(this,"prevTextures",[]);v(this,"prevBuffers",[]);v(this,"render",()=>{const{gl:t,program:r,mainTexture:a,prevTextures:i,prevBuffers:s,viewport:l}=this;if(!(!t||!r||!a||!i)){{t.viewport(l.x,0,l.width,l.height),t.bindFramebuffer(t.FRAMEBUFFER,null),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,a);for(let f=0;f<i.length;f++)t.activeTexture(t.TEXTURE1+f),t.bindTexture(t.TEXTURE_2D,i[f]);t.drawArrays(t.TRIANGLE_STRIP,0,4)}t.viewport(0,0,window.innerWidth,window.innerHeight);for(let f=i.length-1;f>=0;f--)t.bindFramebuffer(t.FRAMEBUFFER,s[f]),t.activeTexture(t.TEXTURE1+f),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,a),t.drawArrays(t.TRIANGLE_STRIP,0,4);t.finish(),this.animationFrame=requestAnimationFrame(this.render)}});if(!t)throw new Error("No canvas");const r=t.getContext("webgl",{antialias:!1,depth:!1,alpha:!1,stencil:!1,desynchronized:!1,preserveDrawingBuffer:!0,powerPreference:"high-performance"});if(!r)throw new Error("Could not get WebGL context");this.gl=r;const{program:a,vloc:i,tloc:s}=Xe(r);let l=4;const{mainTexture:f,prevTextures:E}=Me(r,l);this.mainTexture=f,this.prevTextures=E;const{vertexBuffer:_,texcoordBuffer:R,prevBuffers:A}=Ne(r,E);this.program=a,r.uniform1i(r.getUniformLocation(a,"external_texture"),0);for(let w=0;w<E.length;w++)r.uniform1i(r.getUniformLocation(a,"u_prev_frame_texture["+w+"]"),w+1);r.bindBuffer(r.ARRAY_BUFFER,_),r.vertexAttribPointer(i,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(i),r.bindBuffer(r.ARRAY_BUFFER,R),r.vertexAttribPointer(s,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(s),this.prevBuffers=A,this.resize(window.innerWidth,window.innerHeight),requestAnimationFrame(this.render)}resize(t,r){const{gl:a}=this;if(!a)return;const i=window.innerWidth,s=window.innerHeight,l=Math.min(i/t,s/r),f=t*l,E=r*l,_=(f-i)/2,R=(E-s)/2;a.canvas.width=i,a.canvas.height=s,this.viewport={x:_,y:R,width:i,height:s},a.viewport(_,R,i,s),a.canvas.width=t,a.canvas.height=r,this.canvasSize={width:t,height:r};for(const A of this.prevTextures)a.bindTexture(a.TEXTURE_2D,A),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,i,s,0,a.RGBA,a.UNSIGNED_BYTE,new Uint8Array(i*s*4));this.applyQuality(),this.applyOffset()}resizeByAspect(t){const r=window.innerWidth,a=window.innerHeight;let i=a*t,s=r/t;i>r?i=r:s=a,this.resize(i,s)}setQuality(t){const{canvasSize:r}=this;this.quality=t,this.resize(r.width,r.height)}setXOffset(t){const{canvasSize:r}=this;this.xOffset=-t,this.resize(r.width,r.height)}setYOffset(t){const{canvasSize:r}=this;this.yOffset=t,this.resize(r.width,r.height)}applyQuality(){const{gl:t,quality:r,viewport:a,canvasSize:i}=this;if(!t)return;const s=a.x*r,l=a.y*r,f=a.width*r,E=a.height*r;t.viewport(s,l,f,E),t.canvas.width=i.width*r,t.canvas.height=i.height*r}applyOffset(){const{gl:t,xOffset:r,yOffset:a}=this;if(!t)return;const i=window.innerWidth,s=window.innerHeight,[l,f,E,_]=t.getParameter(t.VIEWPORT),R=l*2+i,A=f*2+s,w=l+(i-R)*r,g=f+(s-A)*a;this.viewport={x:w,y:g,width:E,height:_},t.viewport(w,g,E,_)}destroy(t=!1){var r,a;this.animationFrame&&cancelAnimationFrame(this.animationFrame),!t&&((r=this.gl)!=null&&r.canvas)&&"remove"in this.gl.canvas&&this.gl.canvas.remove(),this.gl&&((a=this.gl.getExtension("WEBGL_lose_context"))==null||a.loseContext(),this.gl=null)}pause(){this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)}resume(){this.animationFrame||(this.animationFrame=requestAnimationFrame(this.render))}}function Ge(){var Z;const e=M(Se),[t,r]=d.useState(!1),[a,i]=d.useState("Photo"),[s,l]=d.useState(!1),[f,E]=d.useState(!1),[_,R]=d.useState(!1),[A,w]=d.useState(!1),[g,j]=d.useState(!1),[se,Q]=d.useState(0);d.useState({});const k=d.useRef(null),z=d.useRef(null),S=d.useRef(null),K=M(Y.Visible),G=M(Y.Unlocked),U=d.useRef(null),F=d.useRef(null),x=["Video","Photo"],y=M(Fe),C=M(ne),B=d.useRef(!1),oe=()=>{if(p("Camera",{action:B.current?"open":"close"}),U.current&&U.current.resume(),F.current||Ce("Camera").then(n=>{n&&(F.current=n)}),p("Camera",{action:"flipCamera",value:A}),L.APPS.CAMERA.lastImage.value)return X(L.APPS.CAMERA.lastImage.value);p("Camera",{action:"getLastPhoto"}).then(n=>{n&&X(n)})},ce=()=>{p("Camera",{action:"close"}),g&&j(!1),U.current&&U.current.pause(),F.current&&(De("Camera"),F.current=null)};d.useEffect(()=>{var o;const n=!(y!=null&&y.visible)&&((o=C==null?void 0:C.active)==null?void 0:o.name)==="Camera"&&K&&G;B.current!==n&&(B.current=n,T("info","Camera app active:",n),n?oe():ce())},[y==null?void 0:y.visible,(Z=C==null?void 0:C.active)==null?void 0:Z.name,K,G]),Te("camera:usedCommand",n=>{if(!B.current)return T("info","camera:usedCommand - camera app is not active");switch(T("info","camera:usedCommand",n),n){case"takePhoto":N();break;case"toggleFlash":l(o=>!o);break;case"leftMode":i(o=>x.indexOf(o)===0?x[x.length-1]:x[x.indexOf(o)-1]);break;case"rightMode":i(o=>x.indexOf(o)===x.length-1?x[0]:x[x.indexOf(o)+1]);break;case"toggleFlip":w(o=>!o);break}});const ue=n=>{let o=(n%60).toString().padStart(2,"0"),c=(Math.floor(n/60)%60).toString().padStart(2,"0");return Math.floor(n/3600).toString().padStart(2,"0")+":"+c+":"+o};d.useEffect(()=>{if(!S.current||U.current)return;let n=new Oe(S.current);n.resizeByAspect(4/3),U.current=n},[S.current]),d.useEffect(()=>{if(!B.current)return T("info","camera app is not active, not triggering flipCamera");p("Camera",{action:"flipCamera",value:A})},[A]),d.useEffect(()=>{if(!z.current)return;let n=[];const c=setInterval(()=>{n.length>2&&(n=[]),n.push("."),z.current.innerText=ae("APPS.CAMERA.UPLOADING")+n.join("")},500);return()=>clearInterval(c)},[t]),d.useEffect(()=>{if(!g||!S.current)return;const o=S.current.captureStream(e.Video.FrameRate??24),c=new AudioContext,u=new MediaStreamAudioDestinationNode(c);F.current?c.createMediaStreamSource(F.current).connect(u):c.createOscillator().connect(u),Pe("Camera",c,u);const P=[o.getTracks()[0]];(F.current||e.RecordNearbyVoices)&&P.push(u.stream.getAudioTracks()[0]);const fe=new MediaStream(P),b=new MediaRecorder(fe,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:e.Video.Bitrate*8*1e3});let W=0,ee=[];const le=b.audioBitsPerSecond+b.videoBitsPerSecond,te=setInterval(()=>{const m=(Date.now()-W)/1e3,V=le*m/8/1024/1024,O=re(V,2);O>=e.Video.MaxSize&&(T("info",`Video file size limit reached (${O}mb)`),clearInterval(te),N())},100);b.ondataavailable=m=>{var I;((I=m==null?void 0:m.data)==null?void 0:I.size)>0&&ee.push(m.data)},b.onerror=m=>{T("error","error recording:",m)},b.onstop=async()=>{r(!0),clearInterval(te);const m=Date.now()-W,I=new Blob(ee,{type:"video/webm"});c.close(),Ue("Camera");const V=await ye(I,m,{logger:!1});r(!1);try{await J(V,!0),r(!1)}catch(O){r(!1),R(O.message),await new Promise(de=>setTimeout(de,7500)),R(!1)}},W=Date.now(),b.start();const H=setInterval(()=>{Q(m=>m>=e.Video.MaxDuration?(clearInterval(H),T("info","Max duration reached, stopping recording"),N(),0):m+1)},1e3);return()=>{Q(0),H&&clearInterval(H),b.state==="recording"&&b.stop(),s&&p("toggleFlashlight",!1),p("Camera",{action:"toggleHud",hide:!1}),T("info","stopped recording")}},[g]);async function J(n,o){const c=re(n.size/1e3,2),u=await ve(o?"Video":"Image",n);return o?X(URL.createObjectURL(n),!0):X(u),T("info",`Saving ${o?"video":"photo"} to gallery (${c}kb) - ${u}, args(${u}, ${c}, ${A&&!o?"selfie":null})`),await Ee(u,c,A&&!o?"selfie":null,!0),!0}async function N(){var o,c;if(f)return T("info","Already taking photo");if(t)return T("info","Already uploading");if(await p("Camera",{action:"toggleHud",hide:!0}),a==="Video"){!g&&s&&await p("toggleFlashlight",!0),j(u=>!u),T("info","Type is video");return}s&&await p("toggleFlashlight",!0),E(!0),r(!0),(c=(o=pe.value)==null?void 0:o.sound)!=null&&c.silent||Re.set({url:"./assets/sound/other/cameraShutter.mp3"}),$.IndicatorVisible.set(!1),T("info","Uploading image, converting to blob");const n=await new Promise(u=>{S.current.toBlob(u,e.Image.Mime,e.Image.Quality)});s&&p("toggleFlashlight",!1).then(()=>Y.Flashlight.set(!1)),p("Camera",{action:"toggleHud",hide:!1});try{await J(n,!1),r(!1),T("info","Uploaded"),$.IndicatorVisible.set(!0)}catch(u){r(!1),R(u.message),T("warning","Failed upload"),$.IndicatorVisible.set(!0),await new Promise(P=>setTimeout(P,7500)),R(!1)}E(!1)}const X=(n,o)=>{if(o===void 0&&(o=be(n)!==null),o){const c=document.createElement("video");c.src=n,c.muted=!0,c.play();const u=document.createElement("canvas");if(!u)return;c.addEventListener("loadeddata",()=>{u.width=c.videoWidth,u.height=c.videoHeight,u.getContext("2d").drawImage(c,0,0,u.width,u.height);const P=u.toDataURL("image/png");k.current.style.backgroundImage=`url(${P})`,L.APPS.CAMERA.lastImage.set(P),u.remove(),c.remove()})}else k.current.style.backgroundImage=`url(${n})`,L.APPS.CAMERA.lastImage.set(n)};return h(Ae,{children:D("div",{className:"camera-container",children:[h("canvas",{ref:S,style:{visibility:f?"hidden":"visible"}}),t&&D("div",{className:"loading",children:[h(xe,{size:80,speed:1,color:"#ffffff"}),h("div",{className:"uploading",ref:z,children:ae("APPS.CAMERA.UPLOADING")})]}),_&&h("div",{className:"loading",children:D("div",{className:"uploading",children:["Failed to upload, tell the server owner to check their API keys in lb-tablet/server/apiKeys.lua",h("br",{}),h("br",{}),_]})}),D("div",{className:"absolute-elements",children:[h(_e,{children:a==="Video"&&h(q.div,{className:"timer",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15,ease:"easeInOut"},children:ue(se)},"timer")}),D("div",{className:"right-panel",children:[D("div",{className:"buttons",children:[h(q.button,{whileTap:{scale:.9},className:"button","data-active":s,onClick:()=>l(n=>!n),children:h(we,{})}),h(q.button,{whileTap:{scale:.9},className:"button",onClick:()=>w(n=>!n),children:h(ge,{})})]}),h("div",{className:"camera-button",onClick:N,children:h("div",{className:"camera-button-container",children:h("div",{className:`camera-button-inner ${a=="Video"&&`${a} ${g==!0&&"Recording"}`}`})})}),h("div",{className:"image-gallery",ref:k,onClick:()=>{G&&(p("Camera",{action:"close"}),ne.patch({active:{name:"Photos"}}))}}),h("div",{className:"actions",children:x.map((n,o)=>h("div",{className:"action","data-active":a===n,onClick:()=>i(n),children:n},o))})]})]})]})})}export{Ge as default};
